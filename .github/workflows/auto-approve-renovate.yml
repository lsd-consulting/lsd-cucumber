name: Auto-approve Renovate PRs

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read

jobs:
  auto-approve:
    if: github.event.pull_request.user.login == 'renovate[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Check if PR should be auto-approved
        id: check
        run: |
          # Extract PR metadata
          pr_title="${{ github.event.pull_request.title }}"
          pr_body="${{ github.event.pull_request.body }}"
          pr_labels="${{ join(github.event.pull_request.labels.*.name, ',') }}"
          
          echo "PR Title: $pr_title"
          echo "PR Labels: $pr_labels"
          
          # Check for auto-approval criteria
          should_approve=false
          
          # Auto-approve test dependencies (no semantic release impact)
          if [[ "$pr_title" =~ ^test: ]]; then
            echo "âœ… Test dependency update - auto-approving"
            should_approve=true
          fi
          
          # Auto-approve minor/patch updates for safe dependencies
          if [[ "$pr_labels" =~ minor|patch ]]; then
            case "$pr_title" in
              *"kotlin"*|*"dokka"*|*"junit"*|*"assertj"*|*"cucumber"*|*"j2html"*|*"plantuml"*)
                echo "âœ… Safe dependency minor/patch update - auto-approving"
                should_approve=true
                ;;
              *"lsd-consulting"*)
                echo "âš ï¸  LSD dependency - requires manual review"
                should_approve=false
                ;;
            esac
          fi
          
          # Never auto-approve major updates
          if [[ "$pr_labels" =~ major ]]; then
            echo "âŒ Major update detected - requires manual review"
            should_approve=false
          fi
          
          echo "should_approve=$should_approve" >> $GITHUB_OUTPUT

      - name: Auto-approve PR
        if: steps.check.outputs.should_approve == 'true'
        uses: juliangruber/approve-pull-request-action@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          number: ${{ github.event.pull_request.number }}

      - name: Add comment explaining auto-approval
        if: steps.check.outputs.should_approve == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸ¤– **Auto-approved by workflow**
              
              This Renovate PR was automatically approved because:
              - âœ… It's a safe dependency update (minor/patch)
              - âœ… Tests must still pass before merge
              - âœ… Low risk of breaking changes
              
              Major updates and LSD dependencies still require manual review.`
            })

      - name: Enable auto-merge
        if: steps.check.outputs.should_approve == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              event: 'APPROVE'
            })